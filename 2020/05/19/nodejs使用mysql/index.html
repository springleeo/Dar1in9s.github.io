<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="nodejs使用mysql"><meta name="keywords" content="node.js"><meta name="author" content="Dar1in9"><meta name="copyright" content="Dar1in9"><title>nodejs使用mysql | Dar1in9's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="http://ta.qq.com"><script>(function() {
   var hm = document.createElement("script");
   hm.src = "https://tajs.qq.com/stats?sId=&lt;script type=&quot;text/javascript&quot; src=&quot;http://tajs.qq.com/stats?sId=66549793&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;";
   var s = document.getElementsByTagName("script")[0];
   s.parentNode.insertBefore(hm, s);
 })();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"MY1GAADR9W","apiKey":"5032629da4e94f659d98a4052bc1c5cd","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#连接"><span class="toc-number">1.</span> <span class="toc-text">连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#建立连接"><span class="toc-number">1.1.</span> <span class="toc-text">建立连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关闭连接"><span class="toc-number">1.2.</span> <span class="toc-text">关闭连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#切换用户和改变连接"><span class="toc-number">1.3.</span> <span class="toc-text">切换用户和改变连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接池"><span class="toc-number">2.</span> <span class="toc-text">连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#连接池连接"><span class="toc-number">2.1.</span> <span class="toc-text">连接池连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#管理连接池连接"><span class="toc-number">2.2.</span> <span class="toc-text">管理连接池连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接池关闭"><span class="toc-number">2.3.</span> <span class="toc-text">连接池关闭</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行sql语句"><span class="toc-number">3.</span> <span class="toc-text">执行sql语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#执行查询"><span class="toc-number">3.1.</span> <span class="toc-text">执行查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询编码与安全"><span class="toc-number">4.</span> <span class="toc-text">查询编码与安全</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多语句查询"><span class="toc-number">5.</span> <span class="toc-text">多语句查询</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://blog-1300147235.cos.ap-chengdu.myqcloud.com/01.png"></div><div class="author-info__name text-center">Dar1in9</div><div class="author-info__description text-center">幸福不是故事，不幸才是</div><div class="follow-button"><a href="https://github.com/Dar1in9s" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">51</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-1300147235.cos.ap-chengdu.myqcloud.com/18085.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Dar1in9's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">nodejs使用mysql</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-19</time><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1.9k</span><span class="post-meta__separator">|</span><span>阅读时长: 7 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p><code>node-mysql</code>是一个实现了MySQL协议的Node.js JavaScript客户端，通过这个模块可以与MySQL数据库建立连接、执行查询等操作</p>
<a id="more"></a>
<p><strong>安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install mysql</span></span><br></pre></td></tr></table></figure>
<p><strong>示例</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;   <span class="comment">// 配置连接信息</span></span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="string">'3306'</span>,</span><br><span class="line">    user: <span class="string">'root'</span>,</span><br><span class="line">    password: <span class="string">'password'</span>,</span><br><span class="line">    database: <span class="string">'my_db'</span></span><br><span class="line">&#125;);</span><br><span class="line">connection.connect(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'connect error: '</span> + err.message)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)   <span class="comment">// 连接数据库</span></span><br><span class="line">connection.query(<span class="string">'SELECT 1 + 1 AS solution'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, rows, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'The solution is: '</span>, rows[<span class="number">0</span>].solution)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">connection.end()    <span class="comment">// 断开连接</span></span><br></pre></td></tr></table></figure>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>建立连接可以使用<code>createConnection()</code>方法创建连接对象，再使用<code>connect()</code>建立连接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;   <span class="comment">// 配置连接信息</span></span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="string">'3306'</span>,</span><br><span class="line">    user: <span class="string">'root'</span>,</span><br><span class="line">    password: <span class="string">'root'</span>,</span><br><span class="line">    database: <span class="string">'db'</span>,</span><br><span class="line">    charset: <span class="string">'UTF8'</span></span><br><span class="line">&#125;);</span><br><span class="line">connection.connect(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'connect error: '</span> + err.message)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>连接参数也可以一个查询字符串的形式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(<span class="string">'mysql://user:pass@host/db?debug=true&amp;charset=UTF8&amp;timezone=-0700'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h3><p>关闭数据库连接可以使用两种方法。</p>
<ol>
<li>通过<code>end()</code>方法，在执行结束后关闭连接<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connection.end(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// The connection is terminated now</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>使用<code>destroy()</code>方法，这个方法会立即关闭连接套接字，而不管执行是否完毕，且这个方法没有回调函数<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connection.destroy();</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="切换用户和改变连接"><a href="#切换用户和改变连接" class="headerlink" title="切换用户和改变连接"></a>切换用户和改变连接</h3><p>MySQL可以在当前不关闭套接字的情况下切换用户和改变连接，通过<code>changeUser()</code>方法能够实现这一功能：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connection.changeUser(&#123;<span class="attr">user</span> : <span class="string">'admin'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>调用这一方法时可以传入一个包含以下可选值的对象：</p>
<ul>
<li>user－新用户的用户名（默认为之前用户）</li>
<li>password－新用户的密码（默认为之前用户密码）</li>
<li>charset－新连接的编码（默认为之前连接的字符编码）</li>
<li>database－新连接的数据库（默认为之前数据库）</li>
</ul>
<h2 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h2><p>数据库连接是一种有限的，能够显著影响到整个应用程序的伸缩性和健壮性的资源，在多用户的网页应用程序中体现得尤为突出。</p>
<p>数据库连接池正是针对这个问题提出来的，它会负责分配、管理和释放数据库连接，允许应用程序重复使用一个现有的数据库连接，而不是重新建立一个连接，释放空闲时间超过最大允许空闲时间的数据库连接以避免因为连接未释放而引起的数据库连接遗漏。数据库连接池能明显提高对数据库操作的性能。</p>
<h3 id="连接池连接"><a href="#连接池连接" class="headerlink" title="连接池连接"></a>连接池连接</h3><p>通过<code>createPool()</code>方法可以使用连接池连接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pool  = mysql.createPool(&#123;</span><br><span class="line">  connectionLimit : <span class="number">10</span>,</span><br><span class="line">  host : <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  user : <span class="string">'root'</span>,</span><br><span class="line">  password : <span class="string">'root'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">pool.query(<span class="string">'SELECT username from users'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(rows);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过<code>getConnection()</code>方法连接可以共享一个连接，或管理多个连接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pool  = mysql.createPool(&#123;</span><br><span class="line">  host : <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  user : <span class="string">'root'</span>,</span><br><span class="line">  password : <span class="string">'root'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// connected! (unless `err` is set)</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="管理连接池连接"><a href="#管理连接池连接" class="headerlink" title="管理连接池连接"></a>管理连接池连接</h3><p>连接使用完后通过调用<code>connection.release()</code>方法可以将连接返回到连接池中，这个连接可以被其它人重复使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"><span class="keyword">var</span> pool  = mysql.createPool(&#123;</span><br><span class="line">  host : <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  user : <span class="string">'root'</span>,</span><br><span class="line">  password : <span class="string">'root'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Use the connection</span></span><br><span class="line">  connection.query( <span class="string">'SELECT something FROM sometable'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, rows</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// And done with the connection.</span></span><br><span class="line">    connection.release();  <span class="comment">//放回连接池</span></span><br><span class="line">    <span class="comment">// Don't use the connection here, it has been returned to the pool.</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="连接池关闭"><a href="#连接池关闭" class="headerlink" title="连接池关闭"></a>连接池关闭</h3><p>当使用完连接池，要关闭所有连接，Node.js的事件循环在MySQL服务关闭前全然会有效。我们可以使用<code>end()</code>方法关闭连接池中的所有连接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pool.end(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// all connections in the pool have ended</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="执行sql语句"><a href="#执行sql语句" class="headerlink" title="执行sql语句"></a>执行sql语句</h2><h3 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h3><p>在node-mysql中，通过<code>Connection</code>或<code>Pool</code>实例的<code>query()</code>执行SQL语句，所执行的SQL语句可以是一个SELECT查询或是其它数据库操作。<code>query()</code>方法有以下三种形式（他们的返回值都是数组类型，数组中内容为查询结果对象）：<br><code>.query(sqlString, callback)</code></p>
<ul>
<li><code>sqlString</code>－要执行的SQL语句</li>
<li><code>callback</code>－回调函数，其形式为<code>function (error, results, fields) {}</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'SELECT * FROM `books` WHERE `author` = "David"'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// error 是一个错误对象，在查询发生错误时存在</span></span><br><span class="line">  <span class="comment">// results 为查询结果</span></span><br><span class="line">  <span class="comment">// fields 包含查询结果的字段信息</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>.query(sqlString, values, callback)</code></p>
<ul>
<li><code>sqlString</code>－要执行的SQL语句</li>
<li><code>values</code>－<code>{Array}</code>，要应用到查询占位符的值</li>
<li><code>callback</code>－回调函数，其形式为<code>function (error, results, fields) {}</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'SELECT * FROM `books` WHERE `author` = ?'</span>, [<span class="string">'David'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// error 是一个错误对象，在查询发生错误时存在</span></span><br><span class="line">  <span class="comment">// results 为查询结果</span></span><br><span class="line">  <span class="comment">// fields 包含查询结果的字段信息</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>.query(sqlString, values, callback)</code></p>
<ul>
<li><code>options</code>－<code>{Object}</code>，查询选项参数</li>
<li><code>callback</code>－回调函数，其形式为<code>function (error, results, fields) {}</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connection.query(&#123;</span><br><span class="line">  sql: <span class="string">'SELECT * FROM `books` WHERE `author` = ?'</span>,</span><br><span class="line">  timeout: <span class="number">40000</span>, <span class="comment">// 40s</span></span><br><span class="line">  values: [<span class="string">'David'</span>]</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// error 是一个错误对象，在查询发生错误时存在</span></span><br><span class="line">  <span class="comment">// results 为查询结果</span></span><br><span class="line">  <span class="comment">// fields 包含查询结果的字段信息</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当使用参数占位符时，第二种和第三种形式也可以结合使用。如，可以将上例中的<code>values</code>值独立为一个参数传入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">connection.query(&#123;</span><br><span class="line">  sql: <span class="string">'SELECT * FROM `books` WHERE `author` = ?'</span>,</span><br><span class="line">  timeout: <span class="number">40000</span> <span class="comment">// 40s</span></span><br><span class="line">&#125;, [<span class="string">'David'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// error 是一个错误对象，在查询发生错误时存在</span></span><br><span class="line">  <span class="comment">// results 为查询结果</span></span><br><span class="line">  <span class="comment">// fields 包含查询结果的字段信息</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="查询编码与安全"><a href="#查询编码与安全" class="headerlink" title="查询编码与安全"></a>查询编码与安全</h2><p>为了防止SQL注入，可以传入参数进行编码。参数编码方法有：<br><code>mysql.escape()</code>、<code>connection.escape()</code>、<code>pool.escape()</code>，这三个方法可以在你需要的时候调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> userId = <span class="string">'some user provided value'</span>;</span><br><span class="line"><span class="keyword">var</span> sql    = <span class="string">'SELECT * FROM users WHERE id = '</span> + connection.escape(userId);</span><br><span class="line">connection.query(sql, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>同样的，也可以使用<code>?</code>做为查询参数占位符，这与查询值编码效果是一样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'SELECT * FROM users WHERE id = ?'</span>, [userId], <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在使用查询参数占位符时，在其内部自动调用<code>connection.escape()</code>方法对传入参数进行编码。</p>
<p><code>escape()</code>方法编码规则如下：</p>
<ul>
<li><code>Numbers</code>不进行转换</li>
<li><code>Booleans</code>转换为<code>true</code>/<code>false</code></li>
<li><code>Date</code>对象转换为’<code>YYYY-mm-dd HH:ii:ss</code>‘字符串</li>
<li><code>Buffers</code>转换为hex字符串，如X’0fa5’</li>
<li><code>Strings</code>进行安全转义<br>在<code>&#39; &quot; \0</code></li>
<li><code>Arrays</code>转换为列表，如<code>[&#39;a&#39;, &#39;b&#39;]</code>会转换为<code>&#39;a&#39;, &#39;b&#39;</code></li>
<li>多维数组转换为组列表，如<code>[[&#39;a&#39;, &#39;b&#39;], [&#39;c&#39;, &#39;d&#39;]]</code>会转换为<code>(&#39;a&#39;, &#39;b&#39;), (&#39;c&#39;, &#39;d&#39;)</code></li>
<li><code>Objects</code>会转换为<code>key=value</code>键值对的形式</li>
<li><code>undefined/null</code>会转换为<code>NULL</code></li>
</ul>
<p>使用查询查询占位符时时，其自动转换如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> post  = &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">title</span>: <span class="string">'Hello MySQL'</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> query = connection.query(<span class="string">'INSERT INTO posts SET ?'</span>, post, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Next</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(query.sql); <span class="comment">// INSERT INTO posts SET `id` = 1, `title` = 'Hello MySQL'</span></span><br></pre></td></tr></table></figure>
<p>如果你要自己进行编码，可以像下面这样的使用编码函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> query = <span class="string">"SELECT * FROM posts WHERE title="</span> + mysql.escape(<span class="string">"Hello MySQL"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(query); <span class="comment">// SELECT * FROM posts WHERE title='Hello MySQL'</span></span><br></pre></td></tr></table></figure>

<h2 id="多语句查询"><a href="#多语句查询" class="headerlink" title="多语句查询"></a>多语句查询</h2><p>出于安全考虑node-mysql默认禁止多语句查询（可以防止SQL注入），启用多语句查询可以将<code>multipleStatements</code>选项设置为<code>true</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;<span class="attr">multipleStatements</span>: <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>启用后可以在一个<code>query</code>查询中执行多条语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'SELECT 1; SELECT 2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `results`是一个包含多个语句查询结果的数组</span></span><br><span class="line">  <span class="built_in">console</span>.log(results[<span class="number">0</span>]); <span class="comment">// [&#123;1: 1&#125;]</span></span><br><span class="line">  <span class="built_in">console</span>.log(results[<span class="number">1</span>]); <span class="comment">// [&#123;2: 2&#125;]</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Dar1in9</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://dar1in9s.github.io/2020/05/19/nodejs%E4%BD%BF%E7%94%A8mysql/">http://dar1in9s.github.io/2020/05/19/nodejs%E4%BD%BF%E7%94%A8mysql/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Dar1in9s.github.io">Dar1in9's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/node-js/">node.js</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/05/19/nodejs%E4%BD%BF%E7%94%A8redis/"><i class="fa fa-chevron-left">  </i><span>nodejs使用redis</span></a></div><div class="next-post pull-right"><a href="/2020/05/19/express%E6%A1%86%E6%9E%B6/"><span>express框架</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://blog-1300147235.cos.ap-chengdu.myqcloud.com/18085.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By Dar1in9</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/algolia.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>